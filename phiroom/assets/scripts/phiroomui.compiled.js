function justify_thumb(){var k=$("<div></div>");$("#content").append(k);var h=k.width();k.remove();k=Math.ceil((h-3)/327);h=Math.floor((h-(3*k+3))/k);$("article.thumb div.thumb-container").css("width",h).css("height",h).css("line-height",h+"px");h-=24;$("img.thumbnail").css("max-width",h).css("max-height",h)}
function close_overlay(){$("#popup").fadeOut();$("#overlay").fadeOut("normal",function(){$("#popup").remove();justify_thumb()});$("ul.popover").is(":visible")&&$("ul.popover").hide();window.history.back()}function toggle_popover(){$(this).next("ul.popover").is(":visible")?$(this).next("ul.popover").fadeOut():($("ul.popover").fadeOut(),$(this).next("ul.popover").fadeIn());return!1}
function hide_elements(){$("#nav ul.submenu").css({display:"block"}).hide();$("#nav ul.popover, #content article.thumb ul.popover").css({display:"block"}).hide();$("#overlay").css({display:"block"}).hide();$("#lightbox").hide();$(".js-hide").hide()}
function getCookie(k){var h=null;if(document.cookie&&""!=document.cookie)for(var r=document.cookie.split(";"),n=0;n<r.length;n++){var s=jQuery.trim(r[n]);if(s.substring(0,k.length+1)==k+"="){h=decodeURIComponent(s.substring(k.length+1));break}}return h}
$(document).ready(function(){function k(a,b){for(var c in selected[b])if(selected[b][c]==a)return c;return-1}function h(a){if(ctrl_down&&65==a.keyCode){var b;0<selected.thumb.length?(b=selected.thumb[0],$("#"+selected.thumb[0]).addClass("active")):(b=$('[data-selectable="thumb"]').first().attr("id"),$("#"+b).addClass("active"));selected.thumb=[b];$('[data-selectable="thumb"]').addClass("selected");$('[data-selectable="thumb"]').not("#"+b).each(function(){selected.thumb.push($(this).attr("id"))});
a.preventDefault();return!1}}function r(a,b){$("body").prepend('<div id="cursor_img"><img src="'+a+'" /></div>');var c=$("#cursor_img img").width(),d=$("#cursor_img img").height(),e=$("#cursor_img img").position();$("#cursor_img").hide();b&&($("#cursor_img").append('<div class="cursor-multiple"></div><div class="cursor-multiple2"></div>'),$("#cursor_img .cursor-multiple, #cursor_img .cursor-multiple2").css("width",c).css("height",d),$("#cursor_img .cursor-multiple").css("left",e.left+6).css("top",
e.top+6),$("#cursor_img .cursor-multiple2").css("left",e.left+12).css("top",e.top+12));$(document).mousemove(function(a){$("#cursor_img").css("left",a.clientX-75).css("top",a.clientY-50).show();$("#cursor_img img").on("dragstart",function(a){a.preventDefault()})})}function n(){$("#lightbox-image").off("click","#lightbox-next");$("#lightbox-image").off("click","#lightbox-prev");$(document).off("keydown");$("#lightbox-next, #lightbox-prev").remove()}function s(){n();$("#lightbox").fadeOut("normal",
function(){$("#lightbox").remove();$("#overlay").fadeOut()});parent.location.hash="";return!1}function x(){$(document).on("keydown",function(a){39==a.keyCode||32==a.keyCode||78==a.keyCode?$("#lightbox-next").click():37==a.keyCode||8==a.keyCode||80==a.keyCode?$("#lightbox-prev").click():27!=a.keyCode&&81!=a.keyCode||s()})}function y(a){var b=0<a.current_pict?a.current_pict-1:a.pict.length-1,c=a.current_pict<a.pict.length-1?a.current_pict+1:0,d=$('<img id="'+a.pict[c].id+'" src="'+a.pict[c].href+'" alt="'+
a.pict[c].title+'"  />'),e=$('<img  id="'+a.pict[b].id+'"src="'+a.pict[b].href+'" alt="'+a.pict[b].title+'"  />');$("#lb-new").on("click","#lightbox-next",function(b){n();$("#lb-new").attr("id","lb-old");a.current_pict=c;t(a,d)});$("#lb-new").on("click","#lightbox-prev",function(c){n();$("#lb-new").attr("id","lb-old");a.current_pict=b;t(a,e)});$("#lightbox").click(s).children().click(function(a){return!1})}function t(a,b){var c=a.current_pict,d=$(window).width()-80,e=$(window).height()-100;"undefined"==
typeof b&&(b=$('<img id="'+a.pict[c].id+'" src="'+a.pict[c].href+'" alt="'+a.pict[c].title+'"  />'));var w=$('<div class="lb-buttons-wrapper"></div><figcaption>'+a.pict[c].title+"<p>Image "+(c+1)+" of "+a.pict.length+"</p></figcaption");b.one("load",function(){$("#lightbox").prepend('<figure id="lb-new" class="lb-image"></figure>');$("#lb-new").hide();$("#lb-new").append(w);$("#lb-new .lb-buttons-wrapper").append(b);1<a.pict.length&&($(".lb-buttons-wrapper").append('<button id="lightbox-prev">Previous image</button>'),
$(".lb-buttons-wrapper").append('<button id="lightbox-next">Next image</button>'));y(a);x();$("#lb-new").css("opacity","0").show();$("#lb-new img").css("max-width",d).css("max-height",e);var c=$("#lb-new img").width();$("#lb-new img").height();$("#lb-new, #lb-new figcation").css("width",c+4);$("#lb-new").css({left:"50%","margin-left":-(c+4)/2});$("#lb-new").hide().css("opacity","1");0!=$("#lb-old").length&&$("#lb-old").fadeOut(a.fadeDuration,function(){$(this).remove()});$("#lb-new").fadeIn(a.fadeDuration)}).each(function(){this.complete&&
$(this).trigger("load")});document.location.hash="/lightbox/"+a.pict[c].id+"/"}function z(a){return"/"==a.substr(-1)?a.substr(0,a.length-1):a}hide_elements();var A=getCookie("csrftoken");$.ajaxSetup({crossDomain:!1,beforeSend:function(a,b){/^(GET|HEAD|OPTIONS|TRACE)$/.test(b.type)||a.setRequestHeader("X-CSRFToken",A)}});$.ajaxSettings.traditional=!0;$("#frame section").on("click","#pageup",function(){$("#frame section").animate({scrollTop:$("#top").offset().top},1E3);return!1});$("#left_panel").on("click",
"li.togglesubmenu > a:not(a.plus)",function(){0!=$(this).parent().find("ul.submenu:visible").length?($(this).removeClass("selected"),$(this).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")}),$(this).parent().find("ul.submenu").slideUp("normal")):($("#nav ul.submenu").slideUp("normal"),$("#nav li.togglesubmenu > a:not(a.plus)").removeClass("selected"),$(this).addClass("selected"),$(this).parent().find("ul.submenu").slideDown("normal"));return!1}).on("click","a.plus",
toggle_popover);$("#content").on("click","article.thumb a.thumb-menu",toggle_popover);$("#content").on("click","article.thumb a.del",function(){var a=$(this).attr("href"),b=$(this).attr("data-url"),c=$(this).parents("article.thumb");$('#left_panel #nav a.dia[href="'+b+'"] span.count').load(a,function(a){$(c).remove()});return!1});$("body").click(function(){$("ul.popover").fadeOut()});$("#frame").on("click","a.popup",function(a){function b(){$("#popup").load(c,function e(){window.history.pushState(c,
"",c);justify_thumb();$("#popup form input[type=submit]").click(function(){clickedsubmit=$(this).attr("name")});$("#popup form").on("submit",function(){$.ajax({url:c,type:$(this).attr("method"),enctype:"multipart/form-data",data:$(this).serialize()+"&"+clickedsubmit+'=""',success:function(a){if(a.redirect)window.location.href=a.redirect;else if(a.form)$("#popup").html(a.form),a.moveto&&$(document).scrollTop($(a.moveto).offset().top),e();else{if(a.reload)for(var b in a.reload)$(b).empty().append(a.reload[b]);
if(a.append)for(b in a.append)$(b).append(a.append[b]);if(a["delete"])for(b in a["delete"])$(b).remove();if(a.loadurl)for(b in a.loadurl)$(b).load(a.loadurl[b],e),c=a.loadurl[b];a.close||(hide_elements(),close_overlay())}}});$(this).next("footer").prepend('<div class="progress"><span class="hidden">In progress</span></div>');return!1})})}$("#overlay").fadeIn();$("body").prepend('<section id="popup"></section>');$("#popup").hide().fadeIn();var c=$(this).attr("href");b();$("#popup").on("click","a.popup",
function(a){c=$(this).attr("href");$("#popup").empty();b();return!1});a.preventDefault();$("#overlay").click(close_overlay)});$("#left").click(function(){"-300px"!=$("#left_panel").css("left")?($("#left_panel").animate({left:"-300px",opacity:"0.6",transition:"1s left, 1s opacity"}),$("section").animate({left:"3px",transition:"1s left"},justify_thumb),justify_thumb()):($("#left_panel").animate({left:"3px",opacity:"1",transition:"1s left, 1s opacity"}),$("section").animate({left:"306px",transition:"1s left"},
justify_thumb));return!1});justify_thumb();(function(){$("footer").on("click","a.star, a.point",function(a){var b=$(this).attr("href");$(this).parent().load(b);a.preventDefault()})})();$(window).resize(justify_thumb);selected={thumb:[]};ctrl_down=!1;$("body").on("click","[data-selectable]",function(a){function b(){for(var a=0;a<f;a++)$("#"+selected[g][a]).removeClass("selected active");selected[g]=[]}function c(a){$("#"+a).hasClass("selected")||($("#"+a).addClass("selected"),selected[g].push(a),f=
selected[g].length)}function d(a){$("#"+a).removeClass("selected active");var b=k(a,g);0==b?(selected[g].shift(),f=selected[g].length):b==f-1?(selected[g].pop(),f=selected[g].length):-1!=b&&(a=selected[g].slice(0,b),b=selected[g].slice(b+1),selected[g]=a.concat(b),f=selected[g].length)}function e(){if(1<f&&$(this).hasClass("selected")||!$(this).hasClass("selected"))b(),c(h)}var h=$(this).attr("id"),g=$(this).attr("data-selectable"),f=selected[g].length;if(a.shiftKey)if(1>f||$(this).hasClass("active"))e();
else{1==f&&$('[data-selectable="'+g+'"].selected').addClass("active");var l=$('[data-selectable="'+g+'"].active').attr("id");a=function(a,d){b();c(l);c(a.attr("id"));$("#"+l).addClass("active");"prev"==d?a.prevUntil('[data-selectable="'+g+'"].active').addClass("selected"):"next"==d&&a.nextUntil('[data-selectable="'+g+'"].active').addClass("selected");selected[g]=[l];$('[data-selectable="'+g+'"].selected').not("#"+l).each(function(){selected[g].push($(this).attr("id"))})};0!=$(this).prevAll('[data-selectable="'+
g+'"].active').length?a($(this),"prev"):a($(this),"next")}else a.ctrlKey?$(this).hasClass("selected")?($(this).hasClass("active")&&$(this).nextAll('[data-selectable="'+g+'"].selected').first().addClass("active"),d(h),1==f&&$('[data-selectable="'+g+'"].selected.active').removeClass("active")):(1==f&&$("#"+selected[g][0]).addClass("active"),c(h)):e()}).find("article.thumb img").click(function(a){if(!a.shiftKey){var b=$(this).parents().closest("article"),c=b.attr("data-selectable"),d=selected[c].length;
if(b.hasClass("selected")&&!b.hasClass("active")&&1<d){a=selected[c][0];var d=b.attr("id"),e=k(d,c);selected[c][0]=d;selected[c][e]=a;$("#"+a).removeClass("active");b.addClass("active");return!1}}a.preventDefault()});$(document).on("keydown",function(a){a.ctrlKey&&(ctrl_down=!0,h(a))}).on("keyup",function(a){if(a.ctrlKey||17==a.keyCode)ctrl_down=!1});var q=!1,p,l,m,f,d=[],u=function(a){if(null!=f&&(l<f.left||l>f.right||m<f.top||m>f.bottom)){if(f.sortable){var b=f.dom.attr("id"),c=$("#"+b+" div.thumb-container").width()+
15,h=c-24;f.dom.css("margin-left","3px").css("margin-right","0px");$("#"+b+" div.thumb-container").css("width",c);$("#"+b+" img.thumbnail").css("max-width",h)}f.droppable&&f.dom.removeClass("diahover");f=null}for(var e in d)if(l>=d[e].left&&l<=d[e].right&&m>=d[e].top&&m<=d[e].bottom){if(null==f||d[e].dom!=f.dom)d[e].sortable?(b=d[e].dom.attr("id"),d[e].dom.width(),c=$("#"+b+" div.thumb-container").width()-15,h=c-24,$("#"+b+" div.thumb-container").css("width",c),$("#"+b+" img.thumbnail").css("max-width",
h),d[e].dom.css("margin-right",15)):d[e].droppable&&d[e].dom.addClass("diahover"),f=d[e];break}l=a.pageX;m=a.pageY},v=function(a){for(var b in d)if(l>=d[b].left&&l<=d[b].right&&m>=d[b].top&&m<=d[b].bottom){if(d[b].sortable){d[b].dom.css("margin-right","0px").css("margin-left","3px");justify_thumb();($("#"+q).hasClass("selected")?$("[data-draggable].selected").detach():$("#"+q).detach()).insertAfter(d[b].dom);var c=[];$('[data-sortable="'+p+'"]').each(function(){c.push($(this).attr("id"))});a=window.location.pathname+
"order/";$.ajax({type:"POST",url:a,data:{arr:c},error:function(a){alert(a)}})}else if(d[b].droppable){a=d[b].dom.attr("href")+"add/";array=$("#"+q).hasClass("selected")?selected[p]:[q];var f=p,e=d[b].dom;$.ajax({type:"POST",url:a,data:{arr:array},success:function(a){"thumb"==f&&e.children("span.count").html(a)},error:function(a){alert(a)}});d[b].dom.removeClass("diahover")}break}q=!1;lasthovered=p=null;m=l=0;d=[];$("#cursor_img").remove();$(document).unbind("mousemove",u);$(document).unbind("mouseup",
v)};$("[data-draggable]").on("mousedown",function(a){p=$(this).attr("data-draggable");q=$(this).attr("id");src=$(this).find("img").attr("src");f=$(this);if($(this).hasClass("selected")){a=$(this).attr("data-selectable");var b=selected[a].length}b&&1<b?r(src,!0):r(src,!1);$('[data-droppable="'+p+'"]').not($(this)).each(function(){var a=$(this).offset();d.push({dom:$(this),left:a.left,top:a.top,right:a.left+$(this).width(),bottom:a.top+$(this).height(),droppable:!0})});$('[data-sortable="'+p+'"]').not($(this)).each(function(){var a=
$(this).offset();d.push({dom:$(this),left:a.left,top:a.top,right:a.left+$(this).width(),bottom:a.top+$(this).height(),sortable:!0})});$(document).bind("mousemove",u);$(document).bind("mouseup",v)});$("[data-draggable] img").on("dragstart",function(a){a.preventDefault()});$("body").on("click","a[data-lightbox]",function(){var a=$(this).attr("data-lightbox"),b=$(this).parents().prevAll().find('a[data-lightbox="'+a+'"]').length,c=[];$('a[data-lightbox="'+a+'"]').each(function(){data={id:$(this).attr("id"),
href:$(this).attr("href"),title:$("img",this).attr("alt")};c.push(data)});var d={id:a,current_pict:b,pict:c,fadeDuration:1500};$("#overlay").addClass("dark").fadeIn(function(){$("body").prepend('<section id="lightbox"></section>');t(d)});return!1});if("#/lightbox/"==window.location.hash.substring(0,11)){var B=z(window.location.hash.substring(11));$("#"+B).click()}});
