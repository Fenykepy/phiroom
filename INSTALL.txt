#########################################################################
# Phiroom
#
# Copyright 2013 Lavilotte-Rolle Frédéric
#
# @contact <phiroom@lavilotte-rolle.fr>
#
#    This file is part of Phiroom.
#
#   Phiroom is free software: you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation, either version 3 of the License, or
#   (at your option) any later version.
#
#   Phiroom is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with Phiroom in COPYING file.
#   If not, see <http://www.gnu.org/licenses/>.
#
#########################################################################

====== Installation de Phiroom ======

===== Debian 7 « Wheezy » ======

==== Installation des dépendances ====

    # aptitude update
    # aptitude safe-upgrade
    # aptitude install python3 python3-markdown python3-pip python3-yaml fossil libpng12-dev libjpeg-dev libpng12-dev
    # pip-3.2 install Django==1.6
    # pip-3.2 install django-mptt
    # pip-3.2 install Pillow==2.3.0
    # pip-3.2 install pytz
    # pip-3.2 install python-xmp-toolkit==2.0.0



==== Téléchargement des sources ====
    
    # mkdir -p /var/www/phiroom
    $ cd /var/www/phiroom
    $ fossil clone https://fossil.lavilotte-rolle.fr/phiroom-django phiroom.fossil
    $ fossil open phiroom.fossil



==== Base de donnée ====

!!! Il est possible d'utiliser d'autres sgdb mais le sujet ne sera pas traité ici. !!!

=== Sqlite ===
    
    !!! Il n'est par recommandé d'utiliser sqlite sur un serveur en production !!!

    # aptitude install python-sqlite

    - Éditer le fichier /var/www/phiroom/phiroom/settings.py

    $ vim /var/www/phiroom/phiroom/settings.py
    
    - Remplacer si besoins le dictionnaire « DATABASES » par :

        DATABASES = {
            'default': {
                'ENGINE': 'django.db.backends.sqlite3', # Add 'postgresql_psycopg2', 'mysql', 'sqlite3' or 'oracle'.
                'NAME': 'phiroom.sql',                      # Or path to database file if using sqlite3.
                # The following settings are not used with sqlite3:
                'USER': '',
                'PASSWORD': '',
                'HOST': '',                      # Empty for localhost through domain sockets or '127.0.0.1' for localhost through TCP.
                'PORT': '',                      # Set to empty string for default.
            }
        }

    $ python3 manage.py syncdb

    - Créer le super utilisateur

=== Postgresql ===

    # aptitude install postgresql postgresql-contrib python3-postgresql libpq-dev python-dev
    # pip-3.2 install psycopg2
    # su - postgres
    postgres@server:~$ createdb phiroom 
    postgres@server:~$ createuser -P
    Enter name of role to add: phiroom-user
    Enter password for new role:
    Shall the new role be a superuser? (y/n) n
    Shall the new role be allowed to create databases? (y/n) n
    Shall the new role be allowed to create more new roles? (y/n) n
    postgres@server:~$ psql
    psql (9.1.9)
    Type "help" for help.

    postgres=# GRANT ALL PRIVILEGES ON DATABASE phiroom TO phiroom-user;
    GRANT
    postgres=# \q
    postgres@server:~$ logout

    - Afin d'optimiser les performances de la base, il est possible de fixer les options suivantes directement dans /etc/postgresql/9.1/main/postgresql.conf
          
          #------------------------------------------------------------------------------
          # DJANGO CONFIGURATION
          #------------------------------------------------------------------------------
          
          client_encoding = 'UTF8'
          default_transaction_isolation = 'read committed'
          timezone = 'UTC'

    - Relancer postgresql
    # /etc/init.d/postgresql restart (en attendant systemD, mais alors, mais vraiment sans impatience…)
    
    - Créer les tables dans la base
    $ cd /var/www/phiroom
    $ python3 manage.py syncdb

==== Configuration du serveur web ====

=== Installation de Gunicorn ===

    # pip-3.2 install gunicorn

et puis ça fini comme ça :
http://www.kywyxy.net/blog/2013/08/16/faire-tourner-django-avec-nginx/
